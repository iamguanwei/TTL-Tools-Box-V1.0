# 全面重构完成计划

## 一、未完成工作汇总

### 1. 常量未迁移（必须完成）

**问题描述**：Constants.cs中已定义了常量，但MainForm.cs中的原始常量未删除，引用也未迁移。

**MainForm.cs中需要迁移的常量**（17个）：

| 常量名 | MainForm行号 | Constants.cs行号 | 引用次数 |
|--------|-------------|-----------------|---------|
| 整句_分割符号 | 37 | 16 | 2 |
| 半句_分割符号 | 42 | 21 | 2 |
| 分割_最小长度 | 47 | 26 | 3 |
| 对话_分割符号 | 52 | 31 | 2 |
| 存盘_分隔符 | 57 | 40 | 2 |
| 生成段落_分隔符 | 62 | 45 | 12 |
| 默认_角色标识 | 67 | 59 | 8 |
| 角色_文本分隔符 | 72 | 64 | 15 |
| 临时_工作目录 | 77 | 78 | 3 |
| 项目文件_扩展名 | 82 | 50 | 3 |
| Ffmpeg_文件夹 | 94 | 83 | 1 |
| Ffmpeg_文件 | 99 | 88 | 2 |
| TTL角色预览声音_文件夹 | 104 | 93 | 4 |
| TTL角色预览声音_文本 | 109 | 102 | 2 |
| 连接成功_验证间隔秒数 | 119 | 107 | 2 |
| 连接失败_重试间隔秒数 | 124 | 112 | 3 |
| 已丢失_标识后缀 | 129 | 69 | 6 |

**TtlSchemeController.cs重复常量**（3个）：
| 常量名 | 行号 |
|--------|------|
| 连接成功_验证间隔秒数 | 17 |
| 连接失败_重试间隔秒数 | 18 |
| None_Engine_Id | 19 |

---

### 2. 面板拆分（阶段4）

**当前MainForm.cs代码结构**（约6200行）：

| 面板名称 | 区域起始行 | 预估行数 | 复杂度 |
|----------|-----------|---------|--------|
| tp_TTL方案 | 1150 | ~600行 | 中等 |
| tp_文本拆分 | 1744 | ~300行 | 简单 |
| tp_角色映射 | 2034 | ~420行 | 中等 |
| tp_多音字替换 | 2454 | ~660行 | 中等 |
| tp_角色和情绪指定 | 3114 | ~970行 | 复杂 |
| tp_语音生成预处理 | 4086 | ~560行 | 中等 |
| tp_语音生成 | 4651 | ~1560行 | 复杂 |

---

## 二、执行计划

### 阶段1：Git签入（创建回滚点）
```bash
git add .
git commit -m "重构前备份：准备完成常量迁移和面板拆分"
```

### 阶段2：常量迁移

**2.1 修改MainForm.cs**：
1. 添加`using static GW.TTLtoolsBox.WinFormUi.Helper.Constants;`
2. 替换所有常量引用（约70处）
3. 删除冗余常量定义（第37-129行，保留`_软件版本`和`_Setting_Key_LastProjectFolder`）

**2.2 修改TtlSchemeController.cs**：
1. 添加`using static GW.TTLtoolsBox.WinFormUi.Helper.Constants;`
2. 替换常量引用（3处）
3. 删除重复常量定义（第17-19行）

### 阶段3：面板拆分

按复杂度从低到高的顺序拆分：

**3.1 文本拆分面板**（最简单，~300行）
- 创建`UI/Panels/TextSplitPanel.cs`
- 迁移`#region 文本拆分UI操作`中的代码

**3.2 角色映射面板**（中等，~420行）
- 创建`UI/Panels/RoleMappingPanel.cs`
- 迁移`#region 角色映射UI操作`中的代码

**3.3 多音字替换面板**（中等，~660行）
- 创建`UI/Panels/PolyphonicReplacePanel.cs`
- 迁移`#region 多音字替换UI操作`中的代码

**3.4 TTL方案面板**（中等，~600行）
- 创建`UI/Panels/TtlSchemePanel.cs`
- 迁移`#region TTL方案UI操作`中的代码

**3.5 语音生成预处理面板**（中等，~560行）
- 创建`UI/Panels/VoicePreprocessPanel.cs`
- 迁移`#region 语音生成预处理UI操作`中的代码

**3.6 角色和情绪指定面板**（复杂，~970行）
- 创建`UI/Panels/RoleEmotionPanel.cs`
- 迁移`#region 角色和情绪指定UI操作`中的代码

**3.7 语音生成面板**（最复杂，~1560行）
- 创建`UI/Panels/VoiceGenerationPanel.cs`
- 迁移`#region 语音生成UI操作`中的代码

### 阶段4：验证和清理

1. 验证所有功能正常
2. 更新项目文件(.csproj)
3. 更新重构计划文档

---

## 三、面板拆分详细设计

### 每个面板需要包含的内容

1. **UserControl类**：继承ViewBase，实现IView接口
2. **字段**：从MainForm迁移相关私有字段
3. **属性**：暴露必要的公共属性
4. **事件处理方法**：从MainForm迁移UI事件处理
5. **公共方法**：loadData、saveData、refreshUi等
6. **事件**：向MainForm通知状态变化的事件

### 面板与MainForm的交互

1. **依赖注入**：MainForm向面板注入必要的服务（如TtlSchemeController、VoiceGenerationTaskQueue等）
2. **事件通知**：面板通过事件向MainForm通知状态变化
3. **公共接口**：面板暴露公共方法供MainForm调用

---

## 四、预计效果

| 指标 | 重构前 | 重构后 | 变化 |
|------|--------|--------|------|
| MainForm.cs行数 | ~6200行 | ~500行 | -5700行 |
| 新增Panel文件 | 0 | 7 | +7 |
| 代码组织 | 单文件 | 模块化 | 更清晰 |

---

## 五、注意事项

1. **渐进式拆分**：每个面板拆分后验证功能正常再继续
2. **依赖关系**：面板之间可能存在依赖，需要通过事件或接口解耦
3. **控件访问**：面板需要访问MainForm的控件，需要通过属性或方法暴露
4. **状态共享**：面板之间共享的状态需要通过MainForm或服务类管理
5. **保留私有常量**：`_软件版本`和`_Setting_Key_LastProjectFolder`是MainForm私有的，不需要迁移
