# 语音生成逻辑调整计划

## 项目背景
当前软件是一个TTL语音生成工具箱，用于对文字进行处理并发送给TTL引擎生成语音。根据用户需求，需要重新设计整个软件的逻辑，特别是语音生成部分。

## 需求分析
1. **核心功能**：对文字进行处理，最终发送给TTL引擎生成语音
2. **任务管理**：每个生成任务保存成一个语音文件，在"语音生成"表格里占据一行
3. **分批处理**：每个生成任务可能需要分批多次发送给TTL引擎生成语音文件，之后通过ffmpeg处理和合并
4. **语音段标识**：使用"_生成_分隔符"标识语音段，每一个语音段对应一个语音文件
5. **处理流程**：
   - "文本拆分"、"多音字替换"、"语音生成预处理"可以直接处理所有语音段
   - "角色和情绪指定"通过表格上端的按钮和下拉列表框选择下方表格中显示的是哪一段
6. **语音处理**：按照分割策略，每一行调用一次TTL引擎生成临时语音，输出到临时目录，使用ffmpeg添加空白时长，之后合并成最终语音文件

## 调整计划

### 1. 修改语音生成逻辑，实现按语音段分割和合并
- **当前状态**：直接调用TTL引擎生成单个语音文件
- **调整内容**：
  - 修改`executeVoiceGenerationTask`方法，实现分批处理
  - 添加临时语音文件管理逻辑
  - 实现语音文件合并功能

### 2. 实现语音段标识符的处理和传递
- **当前状态**：已定义`_生成_分隔符`，但没有具体处理逻辑
- **调整内容**：
  - 在文本处理流程中保留和传递语音段标识符
  - 在语音生成时根据标识符分割任务
  - 确保每个语音段正确生成对应的语音文件

### 3. 优化角色和情绪指定功能，支持按语音段选择
- **当前状态**：表格显示所有文本行
- **调整内容**：
  - 添加语音段选择下拉列表框
  - 实现按语音段筛选表格内容
  - 确保角色和情绪设置正确应用到对应语音段

### 4. 实现ffmpeg处理逻辑，添加空白时长和合并语音
- **当前状态**：没有ffmpeg处理逻辑
- **调整内容**：
  - 添加ffmpeg调用封装
  - 实现为临时语音文件添加空白时长的功能
  - 实现多个临时语音文件合并为一个最终文件的功能

### 5. 测试整个流程
- **测试内容**：
  - 语音段分割和标识
  - 分批生成语音文件
  - ffmpeg处理和合并
  - 角色和情绪指定
  - 整个流程的完整性和正确性

## 技术实现要点

### 1. 语音段处理
- 使用`_生成_分隔符`分割文本为多个语音段
- 每个语音段作为一个独立的处理单元
- 在处理流程中传递语音段标识

### 2. 临时文件管理
- 创建临时目录存储中间语音文件
- 生成唯一的临时文件名
- 处理完成后清理临时文件

### 3. ffmpeg集成
- 封装ffmpeg命令调用
- 实现音频处理功能：
  - 添加空白时长
  - 合并多个音频文件
  - 转换音频格式（如果需要）

### 4. UI优化
- 添加语音段选择控件
- 优化语音生成任务表格显示
- 提供更详细的任务状态和进度信息

## 实施步骤

1. **分析当前代码结构**：理解现有代码逻辑，特别是语音生成部分
2. **修改语音生成核心逻辑**：实现分批处理和文件合并
3. **添加ffmpeg处理功能**：实现音频处理和合并
4. **优化角色和情绪指定UI**：支持按语音段选择
5. **测试和调试**：确保整个流程正常工作
6. **文档更新**：更新相关文档和注释

## 预期成果

- 实现按语音段分割和生成语音的功能
- 支持使用ffmpeg处理和合并语音文件
- 优化角色和情绪指定功能，支持按语音段选择
- 提高整个系统的稳定性和可靠性
- 提供更友好的用户界面和更详细的任务状态信息