# 全面重构检查与完成计划

## 一、发现的问题汇总

### 1. 常量迁移未完成 ⚠️

**问题描述**：Constants.cs已创建并定义了常量，但MainForm.cs中的原始常量未删除，引用也未迁移。

**涉及文件**：
- `MainForm.cs` - 17个常量定义未删除，约70处引用未迁移
- `TtlSchemeController.cs` - 3个重复常量未删除

**详细列表**：

| 常量名 | MainForm行号 | Constants.cs行号 | 引用次数 |
|--------|-------------|-----------------|---------|
| 整句_分割符号 | 37 | 16 | 2 |
| 半句_分割符号 | 42 | 21 | 2 |
| 分割_最小长度 | 47 | 26 | 3 |
| 对话_分割符号 | 52 | 31 | 2 |
| 存盘_分隔符 | 57 | 40 | 2 |
| 生成段落_分隔符 | 62 | 45 | 12 |
| 默认_角色标识 | 67 | 59 | 8 |
| 角色_文本分隔符 | 72 | 64 | 15 |
| 临时_工作目录 | 77 | 78 | 3 |
| 项目文件_扩展名 | 82 | 50 | 3 |
| Ffmpeg_文件夹 | 94 | 83 | 1 |
| Ffmpeg_文件 | 99 | 88 | 2 |
| TTL角色预览声音_文件夹 | 104 | 93 | 4 |
| TTL角色预览声音_文本 | 109 | 102 | 2 |
| 连接成功_验证间隔秒数 | 119 | 107 | 2 |
| 连接失败_重试间隔秒数 | 124 | 112 | 3 |
| 已丢失_标识后缀 | 129 | 69 | 6 |

**TtlSchemeController重复常量**：
| 常量名 | 行号 |
|--------|------|
| 连接成功_验证间隔秒数 | 17 |
| 连接失败_重试间隔秒数 | 18 |
| None_Engine_Id | 19 |

---

### 2. 预留代码未使用 ℹ️

**Base目录**（已创建但未使用）：
- `IView.cs` - 视图接口
- `IPresenter.cs` - 呈现器接口
- `ViewBase.cs` - 视图基类

**Service目录**（已创建但未使用）：
- `IAudioService.cs` - 音频服务接口
- `AudioService.cs` - 音频服务实现

**说明**：这些是为MVP模式和面板拆分预留的基础设施，当前重构计划中标记为"预留"，暂不需要处理。

---

### 3. 面板未拆分 ℹ️

**问题描述**：MainForm.cs仍有约6200行代码，包含7个TabPage面板的所有代码，未拆分成独立的用户控件。

**当前面板**：
| 面板名称 | 代码区域 | 预估行数 |
|----------|---------|---------|
| tp_TTL方案 | #region TTL方案UI操作 | ~200行 |
| tp_文本拆分 | #region 文本拆分UI操作 | ~300行 |
| tp_角色映射 | #region 角色映射UI操作 | ~400行 |
| tp_多音字替换 | #region 多音字替换UI操作 | ~700行 |
| tp_角色和情绪指定 | #region 角色和情绪指定UI操作 | ~1000行 |
| tp_语音生成预处理 | #region 语音生成预处理UI操作 | ~600行 |
| tp_语音生成 | #region 语音生成UI操作 | ~1600行 |

**说明**：面板拆分是一个较大的重构工作，需要：
1. 为每个面板创建独立的UserControl
2. 实现IView接口
3. 创建对应的Presenter
4. 迁移所有UI事件处理和业务逻辑

这属于"阶段4：Core层优化"的可选工作，不在当前重构范围内。

---

## 二、本次重构范围

### 需要完成的工作 ✅

1. **常量迁移**
   - 迁移MainForm中的常量引用到Constants类
   - 删除MainForm中的冗余常量定义
   - 迁移TtlSchemeController中的常量引用
   - 删除TtlSchemeController中的重复常量定义

### 暂不处理的工作 ⏸️

1. **Base目录预留代码** - 为未来MVP模式预留
2. **Service目录预留代码** - 为未来服务层预留
3. **面板拆分** - 属于可选的后续重构工作

---

## 三、执行计划

### 阶段1：Git签入（创建回滚点）
```bash
git add .
git commit -m "重构前备份：准备完成常量迁移"
```

### 阶段2：修改MainForm.cs

1. 添加using语句：
```csharp
using static GW.TTLtoolsBox.WinFormUi.Helper.Constants;
```

2. 替换所有常量引用（约70处）

3. 删除冗余常量定义（第37-129行，保留以下两个）：
   - `_软件版本`（私有常量，不需要迁移）
   - `_Setting_Key_LastProjectFolder`（私有常量，不需要迁移）

### 阶段3：修改TtlSchemeController.cs

1. 添加using语句：
```csharp
using static GW.TTLtoolsBox.WinFormUi.Helper.Constants;
```

2. 替换常量引用（3处）

3. 删除重复常量定义（第17-19行）

### 阶段4：验证编译

确保所有修改后代码能正常编译，无错误。

---

## 四、预计修改量

| 文件 | 修改类型 | 预计行数 |
|------|---------|---------|
| MainForm.cs | 添加using | 1行 |
| MainForm.cs | 引用替换 | 约70处 |
| MainForm.cs | 删除常量定义 | 约90行 |
| TtlSchemeController.cs | 添加using | 1行 |
| TtlSchemeController.cs | 引用替换 | 3处 |
| TtlSchemeController.cs | 删除常量定义 | 3行 |

**预计净减少代码量**：约90行

---

## 五、注意事项

1. **使用`using static`**：可以简化引用，无需每次写`Constants.常量名`
2. **保留私有常量**：`_软件版本`和`_Setting_Key_LastProjectFolder`是MainForm私有的，不需要迁移
3. **验证功能**：修改后需确保所有功能正常工作
